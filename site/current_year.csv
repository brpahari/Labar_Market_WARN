import glob
import os
import json
import pandas as pd

OUT_DIR = "site"
OUT_CSV = f"{OUT_DIR}/current_year.csv"

WANTED_COLS = [
    "hash_id",
    "company",
    "clean_name",
    "notice_date",
    "effective_date",
    "employee_count",
    "city",
    "state",
    "source_url",
]

HEADER = ",".join(WANTED_COLS) + "\n"

BAD_URL_PARTS = [
    "warn-worker-adjustment-and-retraining-notification",
]

def ensure_site():
    os.makedirs(OUT_DIR, exist_ok=True)
    mp = os.path.join(OUT_DIR, "mappings.json")
    if not os.path.exists(mp):
        with open(mp, "w", encoding="utf-8") as f:
            json.dump({}, f)

def read_csv_guess_sep(path: str) -> pd.DataFrame:
    # Try comma first, then tab
    try:
        return pd.read_csv(path, dtype=str).fillna("")
    except Exception:
        return pd.read_csv(path, dtype=str, sep="\t").fillna("")

def main():
    ensure_site()

    parts = []
    files = sorted(glob.glob("data/*/*.csv"))
    print("Build reading files:", files)

    for path in files:
        try:
            df = read_csv_guess_sep(path)
            if len(df) == 0:
                continue
            parts.append(df)
        except Exception as e:
            print("Skipping", path, e)

    if not parts:
        with open(OUT_CSV, "w", encoding="utf-8") as f:
            f.write(HEADER)
        print("Built site/current_year.csv with 0 rows")
        return

    df = pd.concat(parts, ignore_index=True)

    for c in WANTED_COLS:
        if c not in df.columns:
            df[c] = ""
    df = df[WANTED_COLS]

    if "source_url" in df.columns:
        s = df["source_url"].astype(str)
        bad = False
        mask = pd.Series(False, index=df.index)
        for b in BAD_URL_PARTS:
            mask = mask | s.str.contains(b, na=False)
        df = df[~mask]

    if "hash_id" in df.columns:
        df = df.drop_duplicates(subset=["hash_id"])

    df["_nd"] = pd.to_datetime(df["notice_date"], errors="coerce")
    df = df.sort_values(by="_nd", ascending=False).drop(columns=["_nd"])

    # Force comma output
    df.to_csv(OUT_CSV, index=False, sep=",")
    print("Built site/current_year.csv with", len(df), "rows")

if __name__ == "__main__":
    main()
